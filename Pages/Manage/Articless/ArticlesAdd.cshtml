@page
@model SunuerManageEn.Pages.Manage.Articless.ArticlesAddModel
@{
}
<link href="~/css/bootstrap.min.css" rel="stylesheet">
<script src="~/js/bootstrap.min.js"></script>
<link href="~/css/summernote.min.css" rel="stylesheet" />
<script src="~/js/summernote.min.js"></script>
<script src="~/js/summernote-zh-cn.min.js"></script>

<style>
    .layui-form-label {
        position: relative;
        float: left;
        display: block;
        padding: 9px 15px;
        width: 160px;
        font-weight: 400;
        line-height: 20px;
        text-align: right;
    }

    .layui-input-block {
        margin-left: 190px;
        min-height: 36px;
    }

    pre code {
        background-color: #f5f5f5;
        padding: 10px;
        border-radius: 4px;
        font-family: "Courier New", Courier, monospace;
        font-size: 14px;
        line-height: 1.5;
        display: block;
        white-space: pre-wrap; 
    }
</style>
<style>
    .file-iteme {
        position: relative;
        padding: 0px 20px;
        display: inline-block;
    }
    .layui-icon-close {
        position: absolute;
        top:5px; border:0px solid #666; color:#fff;
        right: 25px;
        z-index: 888
    }

    .file-iteme button {
        margin-top: 5px;
        display: inline-block;
        padding: 5px;
        cursor: pointer;
        font-size: 12px;
    }

    .imgclik{ position:absolute;bottom:7px; left:0px; width:100%; text-align:center;}

        .imgclik span {
            background-color: rgba(0, 0, 0, 0.3); cursor:pointer;
            padding: 6px 17px;color:#fff; border-radius:3px;
            margin: 0px 6px;
        }
    /* Hide the file input box */
    .hidden-file-input {
        display: none;
    }
    .summernote{ width:97%;}

    .layui-form-label{ padding-right:0px;}
</style>
<div class="layui-form" lay-filter="layuiadmin-app-form-list" id="layuiadmin-app-form-list" style="padding: 20px 30px 0 0;">
    <div class="layui-form-item">
        <label class="layui-form-label">Category<span class="red">*</span></label>
        <div class="layui-input-block nselect">
            <div id="ParentIDnow"></div>
            <input name="BigID" id="BigID" class="layui-input" type="hidden" lay-verify="required" autocomplete="off" value="@Model.BigID" />
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">Title <span class="red">*</span></label>
        <div class="layui-input-block">
            <input type="text" name="ArticleTitle" lay-verify="required" placeholder="Please enter Title " autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">Keywords<span class="red">*</span></label>
        <div class="layui-input-block">
            <input type="text" name="Articlekey" lay-verify="required" placeholder="Please enter Keywords" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">Description</label>
        <div class="layui-input-block">
            <textarea name="ArticleDesn" class="layui-textarea" placeholder="" id="ArticleDesn"></textarea>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">Sort Order<span class="red">*</span></label>
        <div class="layui-input-block">
            <input type="text" name="Sorts" lay-verify="required|number" placeholder="Sort Order" autocomplete="off" class="layui-input" value="0" />
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">Show<span class="red">*</span></label>
        <div class="layui-input-block">
            <input type="radio" name="Statues" value="0" title="Yes" lay-filter="Statues" checked>
            <input type="radio" name="Statues" value="1" title="No" lay-filter="Statues">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">Redirect URL</label>
        <div class="layui-input-block">
            <input type="text" name="NavSites" placeholder="Redirect URL" autocomplete="off" class="layui-input" value="" />
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">Publish Time<span class="red">*</span></label>
        <div class="layui-input-block">
            <input type="text" name="ReleaseTime" lay-verify="required" placeholder="Publish Time" autocomplete="off" class="layui-input" value="@DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss")" />
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">Click Rate<span class="red">*</span></label>
        <div class="layui-input-block">
            <input type="text" name="Hits" lay-verify="required|number" placeholder="Click Rate" autocomplete="off" class="layui-input" value="0" />
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">Images</label>
        <div class="layui-input-block">
            <div id="UpImageImage" class="layui-upload-list" style="float: left; margin-left: 10px;">
                <div id="ImagePathImage">
                </div>
                <div class="layui-upload-drag" id="ImageUpImage" style="padding: 0px; display: block;">
                    <i class="layui-icon">&#xe67c;</i>
                    <p>Click to upload, or drag and drop the file here.</p>
                </div>

                <input id="PicturePathImage" name="Image" type="hidden" value="/images/morenimg.png" />

            </div>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">Images Set</label>
        <div class="layui-input-block">
            <div id="UpImageImages" class="layui-upload-list" style="float: left; margin-left: 10px;">
                <div id="ImagePathImages">
                </div>
                <div class="layui-upload-drag" id="ImageUpImages" style="padding: 0px; display: block;">
                    <i class="layui-icon">&#xe67c;</i>
                    <p>Click to upload, or drag and drop the file here.</p>
                </div>

                <input id="PicturePathImages" name="Images" type="hidden" value="" />

            </div>
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">Content</label>
        <div class="layui-input-block">
            <div class="summernote" id="summernote"></div>
            <input type="file" id="fileInput" style="display:none" class="hidden-file-input" multiple />
            <textarea name="Desn" class="layui-textarea" style="display:none" placeholder="" id="Desn"></textarea>
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label"></label>
        <div class="layui-input-inline">
            <input type="button" lay-submit lay-filter="layuiadmin-app-form-submit" class="layui-btn btn" id="layuiadmin-app-form-submit" value=" Confirm Add ">
        </div>
    </div>
</div>

<script src="/js/layuiadmin/xm-select.js"></script>
<style>
    .nselect {
        z-index: 20;
    }

    .wrap {
        width: 80%;
        margin: 40px auto;
        display: flex;
    }

        .wrap > div {
            flex: 1;
            margin: 0 10px;
        }

        .wrap p {
            font-size: 16px;
            font-weight: 600;
            line-height: 40px;
            color: #ffffff;
        }

    .layui-tree-line .layui-tree-entry:hover .layui-tree-txt {
        color: #999;
        text-decoration: none;
        transition: .3s;
    }
</style>
<script>
   
    //Rich Text Edit Box
    $(document).ready(function() {
        $('.summernote').summernote({
            height: 240, //set editable area's height
            toolbar: [
                ['style', ['style']],
                ['font', ['bold', 'underline', 'clear']],
                ['color', ['color']],
                ['para', ['ul', 'ol', 'paragraph']],
                ['table', ['table']],
                ['insert', ['link', 'picture', 'attachment', 'insertCodeBlock']],
                ['view', ['fullscreen', 'codeview', 'help']]
            ],
            buttons: {
                attachment: function() {
                    var ui = $.summernote.ui;
                    var button = ui.button({
                        contents: '<i class="note-icon-paperclip"></i> Attachment', 
                        tooltip: 'Insert attachment',
                        click: function() {
                            $('#fileInput').click();  // Trigger the file selection box
                        }
                    });
                    return button.render();
                }
            },
            codemirror: { // codemirror options
                theme: 'monokai',
                mode: 'text/html',  // Set to HTML mode, supporting Show HTML code
                lineNumbers: true  // Show line numbers
            }, callbacks: {
                onImageUpload: function(files) {
                    // Iterate through all uploaded files and add them to FormData
                    for (var i = 0; i < files.length; i++) {
                        var data = new FormData();
                        data.append("file", files[i]);  // Add multiple files using the array name "files[]"

                        $.ajax({
                            url: '/api/Files/Upload',  // Server images upload API
                            method: 'POST',
                            data: data,
                            contentType: false,
                            processData: false,
                            success: function(response) {
                                //  ImagesUpload success  Return  Images URL
                                var imageUrl = response.FileUrl;
                                $('#summernote').summernote('insertImage', imageUrl);
                            }
                        });
                    }

                }, onFileUpload: function(files) {
                    console.log(files);
                    // Iterate through all uploaded files and add them to FormData
                    for (var i = 0; i < files.length; i++) {

                        var data = new FormData();
                        data.append("file", files[0]);

                        $.ajax({
                            url: '/api/Files/Upload',  // Replace with your file upload API
                            method: 'POST',
                            data: data,
                            contentType: false,
                            processData: false,
                            success: function(response) {
                                $.ajax({
                                    url: '/api/Files/Upload',  // Server file upload API
                                    method: 'POST',
                                    data: data,
                                    contentType: false,
                                    processData: false,
                                    success: function(response) {
                                        // After upload success, return the attachment link and insert it
                                        var fileUrl = response.FileUrl;
                                        $('#summernote').summernote('insertLink', fileUrl, 'Attachment');
                                    }
                                });
                            },
                            error: function(xhr, status, error) {
                                console.log("Upload failed:", error);
                            }
                        });
                    }

                }, onInit: function() {
                    // Manual insert button
                    const $button = $('<button class="note-btn btn btn-default btn-sm" type="button" title="Insert code block"><i class="note-icon-code"></i></button>');
                    $button.on('click', function() {
                        $('#summernote').summernote('editor.pasteHTML', '<pre><code>Your code here...</code></pre>');
                    });
                    $('.note-insert').append($button); // Add the button to the insert toolbar
                }
               
            }

        });
        console.log($('.summernote').next().find('.note-btn')); // Check the buttons in the toolbar

        // Trigger upload when a file is selected in the file input box
        $('#fileInput').on('change', function(e) {
            console.log('File input change event:', e.target.files);
            var files = e.target.files;
            if (files.length > 0) {
                // Call Summernote's onFileUpload event to upload the file 
               uploadFiles(files);
            }
        });
        // Functionality of upload file
        function uploadFiles(files) {
            // Add the selected file to FormData
            for (var i = 0; i < files.length; i++) {
                var data = new FormData();
                data.append("file", files[0]);

                        $.ajax({
                            url: '/api/Files/Upload',  // Server file upload API
                            method: 'POST',
                            data: data,
                            contentType: false,
                            processData: false,
                            success: function(response) {
                                // After upload success, return the attachment link and insert it
                        var fileUrl = response.FileUrl;
                        var fileName = response.FileName;
                        var attachmentLink = `<a href="${fileUrl}" target="_blank">${fileName}</a> `;
                        $('#summernote').summernote('insertNode',  $(attachmentLink)[0]);
                            }
                        });
                   
            }
        }
        $(".layui-btn").bind("click", function(event) {
            $("#Desn").val($('#summernote').summernote('code'));
        });
        console.log($.summernote.plugins)
    });
    //image upload (Images)
    layui.use('upload', function() {
        upload = layui.upload;
        layui.use('upload', function() {
            var upload = layui.upload;
            var i = 0;
            var uploadInst = upload.render({
                elem: '#ImageUpImages',  // Trigger the upload element
                url: '/api/Files/Upload',  // File upload API
                accept: 'images',  // Only allow image uploads
                auto: true,  // Automatic upload
                multiple: true,  // Support multiple file uploads
                size: 1420,  // File size limit (unit: KB)
                before: function(obj) {
                    // Preview file (local preview)
                    var previewDiv = $('#ImagePathImages');
                   // previewDiv.empty();  // Clear the previous preview
                    obj.preview(function(index, file, result) {
                      
                    });
                },
                done: function(res) {
                    if (res.Code !== "0") {
                        return layer.msg(res.Messge);
                    }

                    // If multiple images are uploaded, process the returned URL list
                    var html_txt = "";
                    if (res.FileType == ".pdf") {
                        html_txt += `<div class="file-iteme">
                <a href="${res.FileUrl}" target="_blank"><img src="/images/PDF.png" /></a>
            <i id="del" class="layui-icon layui-icon-close"></i>
        </div>
        `
                    } else if (res.FileType == ".docx" || res.FileType == ".doc") {
                        html_txt += `<div class="file-iteme">
                        <a href="${res.FileUrl}" target="_blank"><img src="/images/DOC.png" /></a>
                <i id="del" class="layui-icon layui-icon-close"></i>
            </div>
            `
                    } else if (res.FileType == ".xlsx" || res.FileType == ".xls") {
                        html_txt += `<div class="file-iteme">
                            <a href="${res.FileUrl}" target="_blank"><img src="/images/excel.jpeg" /></a>
                    <i id="del" class="layui-icon layui-icon-close"></i>
                </div>
                `
                    }
                    else if (res.FileType == ".jpg" || res.FileType == ".png" || res.FileType == ".jpeg" || res.FileType == ".gif") {
                        html_txt += `<div class="file-iteme">
                            <a href="${res.FileUrl}" target="_blank"><img src="${res.FileUrl}"  class=\"layui-upload-img\" /></a>
            <i id="del" class="layui-icon layui-icon-close"></i>
            <div class="imgclik">
                <span class="move-prev">Move forward</span>
                    <span class="move-next">Move backward</span>
                    <span class="move-first">First image</span>
            </div></div>
        `
                    }
                    $('#PicturePathImages').val($('#PicturePathImages').val()+res.FileUrl+"|");

                    $("#ImagePathImages").append(html_txt)
                    if (i == 0) {
                        return layer.msg(res.Messge);
                    }
                    i++;
                },
                error: function() {
                    var demoText = $('#errorText');
                    demoText.html('<span style="color: #FF5722;">Upload failed</span> <a class="layui-btn layui-btn-xs demo-reload">Retry</a>');
                    demoText.find('.demo-reload').on('click', function() {
                        uploadInst.upload();
                    });
                }
            });
        });
        var uploadInst2 = upload.render({
            elem: '#ImageUpImage',
            url: '/api/Files/Upload',
            accept: 'images',
            auto: true,
            size: 1420, // File size limit (unit: KB)
            choose: function(obj) {
                //Pre-read local files (Not supported in IE8)
                var previewDiv = $('#ImagePathImage');
                previewDiv.empty();  // Clear the previous preview
                obj.preview(function(index, file, result) {
                    var imgElement = '<img src="' + result + '" alt="' + file.name + '" class="layui-upload-img" style="max-width:200px; max-height:200px;  margin-right: 10px;"/>';
                    previewDiv.append(imgElement);  // Add preview images
                });
            },
            done: function(res) {
                if (0 != res.Code) {
                    return layer.msg(res.Messge);
                }
                else {
                    var html_txt = "";
                    if (res.FileType == ".pdf") {
                        html_txt += `<div class="file-iteme">
            <a href="${res.FileUrl}" target="_blank"><img src="/images/PDF.png" /></a>
        <i id="del" class="layui-icon layui-icon-close"></i>
    </div>
    `
                    } else if (res.FileType == ".docx" || res.FileType == ".doc") {
                            html_txt += `<div class="file-iteme">
                    <a href="${res.FileUrl}" target="_blank"><img src="/images/DOC.png" /></a>
            <i id="del" class="layui-icon layui-icon-close"></i>
        </div>
        `
                    } else if (res.FileType == ".xlsx" || res.FileType == ".xls") {
                        html_txt += `<div class="file-iteme">
                        <a href="${res.FileUrl}" target="_blank"><img src="/images/excel.jpeg" /></a>
                <i id="del" class="layui-icon layui-icon-close"></i>
            </div>
            `
                    }
                    else if (res.FileType == ".jpg" || res.FileType == ".png" || res.FileType == ".jpeg" || res.FileType == ".gif") {
                        html_txt += `<div class="file-iteme">
                        <a href="${res.FileUrl}" target="_blank"><img src="${res.FileUrl}" class=\"layui-upload-img\" /></a>
        <i id="del" class="layui-icon layui-icon-close"></i>
    </div>
    `
                    }
                    $("#ImagePathImage").html(html_txt)
                    $('#PicturePathImage').val(res.FileUrl);
                    return layer.msg(res.Messge);
                }


            },
            error: function() {
                //Demonstrate Failed Status and implement retry
                var demoText = $('#errorText');
                demoText.html('<span style="color: #FF5722;">Upload failed</span> <a class="layui-btn layui-btn-xs demo-reload">Retry</a>');
                demoText.find('.demo-reload').on('click', function() {
                    uploadInst2.upload();
                });
            }
        });
        //View
        layer.photos({
            photos: '.layui-upload-list',
            anim: 0 //Select from 0-6 to specify the popup image animation type
        });
        // Move forward
        $('body').on('click', '.move-prev', function() {
            var currentItem = $(this).closest('.file-iteme');
            var prevItem = currentItem.prev('.file-iteme');
            if (prevItem.length) {
                currentItem.insertBefore(prevItem);
            }
        });

        // Move backward
        $('body').on('click', '.move-next', function() {
            var currentItem = $(this).closest('.file-iteme');
            var nextItem = currentItem.next('.file-iteme');
            if (nextItem.length) {
                currentItem.insertAfter(nextItem);
            }
        });

        // First image
        $('body').on('click', '.move-first', function() {
            var currentItem = $(this).closest('.file-iteme');
            currentItem.prependTo('#ImagePathImages');
        });
        // DeleteImages
        $(document).on("click", "#del", function(event) {
            $(this).parent().remove();
        });
    });
    layui.config({
        base: '/js/layuiadmin/' //Path of static resources
    }).extend({
        index: 'lib/index' //Main entry module
        , lang: 'lang/en' // Extend a language module
    }).use(['index', 'form', 'layer'], function() {
        var $ = layui.$
            , form = layui.form;
        $.ajax({
            url: "/api/ArticleCategory/Select",
            type: "post",
            data: { ParentID: 0, BigID: "@Model.BigID", Top:1 },
            dataType: "Json",
            success: function(data) {
                var demo1 = xmSelect.render({
                    el: '#ParentIDnow',
                    model: { label: { type: 'text' } },
                    radio: true,
                    clickClose: true,
                    tree: {
                        show: true,
                        strict: false,
                        expandedKeys: true,
                    },
                    height: 'auto',
                    on: function(data) {
                        if (data.isAdd) {
                            $("#BigID").val(data.arr[0].value);
                        }
                    },
                    data: function() {
                        return data.data
                    }
                })
            }
        })
        //Listen for submission
        form.on('submit(layuiadmin-app-form-submit)', function(data) {
            var Images = "";
            var doms = [...$("#ImagePathImages")[0].children]
            if (doms.length > 0) {
                doms.forEach((item, index) => {
                    var anchor = $(item).find("a");
                    if (anchor.length > 0) {
                        var href = anchor.attr("href");
                        if (index === 0) {
                            Images += href;
                        } else {
                            Images += ',' + href;
                        }
                    }
                })
            }
            var field = data.field; //Get submitted fields
            var index = parent.layer.getFrameIndex(window.name); //First, get the current iframe layer's index
            var count = layer.load(1);
            $.ajax({
                url: "/api/Articles/Add",
                type: "post",
                async: false,
                data: {
                    BigID: data.field.BigID,
                    ArticleTitle: data.field.ArticleTitle,
                    Articlekey: data.field.Articlekey,
                    ArticleDesn: data.field.ArticleDesn,
                    Statues: data.field.Statues,
                    Sorts: data.field.Sorts,
                    NavSites: data.field.NavSites,
                    ReleaseTime: data.field.ReleaseTime,
                    Hits: data.field.Hits,
                    Image: data.field.Image,
                    Images: Images,
                    Desn: data.field.Desn
                        },
                success: function(datax) {
                    layer.close(count);
                    if (0 == datax.code) {
                        layer.msg(datax.msg, { time: 1000 }, function() {
                            parent.location.reload()
                            parent.layer.close(index)
                        });
                    } else {
                        layer.msg(datas.msg, {
                            icon: 1,
                            time: 3000 //Close after 2 seconds (if not configured, the default is 3 seconds)）
                        }, function() {
                            layer.closeAll();
                        });
                    }
                },
                error: function(e) {
                    layer.closeAll();
                    alert("Error！！");
                }
            });
        });
    })
</script>